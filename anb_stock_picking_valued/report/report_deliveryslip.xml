<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <template id="report_delivery_document" inherit_id="stock.report_delivery_document">
            <xpath expr="//th[@name='td_sched_date_h']" position="after">
                <th t-if="o.client_order_ref"><strong>Your Reference</strong></th>
                <th name="payment_term" t-if="o.payment_term_id"><strong>Payment Terms</strong></th>
            </xpath>
            <xpath expr="//td[@name='td_sched_date']" position="after">
                <td t-if="o.client_order_ref"><span t-field="o.client_order_ref"/></td>
                <td name="payment_term" t-if="o.payment_term_id"><span t-field="o.payment_term_id"/></td>
            </xpath>
            <xpath expr="//table[@t-if='not o.pack_operation_ids'][1]" position="replace">
                <table class="table table-condensed mt48">
                    <thead>
                        <tr>
                            <!-- Is there a discount on at least one line? -->
                            <t t-set="display_discount" t-value="any([m.discount for m in o.move_lines])"/>
                            <th><strong>Product</strong></th>
                            <th><strong>Ordered Quantity</strong></th>
                            <th class="text-right"><strong>Unit Price</strong></th>
                            <th t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line"><strong>Disc.(%)</strong></th>
                            <th class="text-right"><strong>Taxes</strong></th>
                            <th class="text-right" groups="sale.group_show_price_subtotal"><strong>Price</strong></th>
                            <th class="text-right price_tax_included" groups="sale.group_show_price_total"><strong>Total Price</strong></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr t-foreach="o.move_lines" t-as="move">
                            <td><span t-field="move.product_id"/></td>
                            <td>
                                <span t-field="move.product_uom_qty"/>
                                <span t-field="move.product_uom"/>
                            </td>
                            <td class="text-right">
                                <span t-field="move.move_price_unit"/>
                            </td>
                            <td t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">
                                <span t-field="move.discount"/>
                            </td>
                            <td class="text-right">
                                <span t-esc="', '.join(map(lambda x: (x.description or x.name), move.tax_id))"/>
                            </td>
                            <td class="text-right" groups="sale.group_show_price_subtotal">
                                <span t-field="move.price_subtotal"
                                    t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </td>
                            <td class="text-right" groups="sale.group_show_price_total">
                                <span t-field="move.price_total"
                                    t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </xpath>
            <xpath expr="//table[@t-if='o.pack_operation_ids'][1]" position="replace"/>
            <xpath expr="//p[@t-if='o.backorder_id']" position="before">
                <div class="row" name="total">
                    <div class="col-xs-4 pull-right">
                        <table class="table table-condensed">
                            <tr class="border-black">
                                <td><strong>Total Without Taxes</strong></td>
                                <td class="text-right">
                                    <span t-field="o.amount_untaxed"
                                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                            <t t-foreach="o._get_tax_amount_by_group()" t-as="amount_by_group">
                                <tr>
                                    <td><span t-esc="amount_by_group[0] or 'Taxes'"/></td>
                                    <td class="text-right">
                                        <span t-esc="amount_by_group[1]"
                                            t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                    </td>
                                </tr>
                            </t>
                            <tr class="border-black">
                                <td><strong>Total</strong></td>
                                <td class="text-right">
                                    <span t-field="o.amount_total"
                                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </xpath>
        </template>
    </data>
</openerp>
